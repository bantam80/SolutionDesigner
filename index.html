<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceOS Lead Configurator</title>
    
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style type="text/tailwindcss">
        body{font-family:'Inter',sans-serif;background-color:#f8fafc}
        .section-card{@apply bg-white rounded-xl border border-slate-200 shadow-sm p-8 mb-8 transition-all duration-200}
        .section-card:hover{@apply shadow-md border-blue-200}
        .step-header{@apply mb-6 pb-4 border-b-2 border-slate-100 flex items-end justify-between}
        .step-title{@apply text-2xl font-extrabold text-slate-800 tracking-tight}
        .step-subtitle{@apply text-sm text-slate-400 font-medium uppercase tracking-wider mb-1}
        .input-group{@apply relative bg-slate-50 rounded-lg p-4 border border-slate-200 transition-colors focus-within:bg-white focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500}
        .label-main{@apply block text-sm font-semibold text-slate-700 mb-1}
        .label-sub{@apply block text-xs text-slate-500 mb-3}
        .input-clean{@apply w-24 text-right font-bold text-slate-800 bg-white border border-slate-300 rounded-md py-1.5 px-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all}
        .input-col{@apply w-full text-center font-bold text-slate-800 bg-white border border-slate-300 rounded-md py-2 px-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all}
        .price-tag{@apply text-xs font-medium text-slate-500 mt-1 block text-right}
        .summary-row{@apply flex justify-between text-sm py-2 border-b border-slate-700/50 last:border-0}
        .summary-label{@apply text-slate-400}
        .summary-val{@apply font-medium text-slate-200}
        .acc-panel{@apply mt-3 pt-3 border-t border-slate-100 bg-slate-50/50 rounded-b-lg px-1}
        .acc-label{@apply text-[10px] font-bold text-slate-400 mb-1 block uppercase tracking-wide text-center}
        .acc-input{@apply w-full text-xs border-slate-200 rounded p-1 text-center font-semibold focus:ring-1 focus:ring-blue-500 outline-none bg-white disabled:bg-slate-100 disabled:text-slate-400}
        
        /* PDF TEMPLATE STYLES */
        .pdf-container { font-family: 'Segoe UI', Arial, sans-serif; background: #fff; padding: 40px; width: 900px; color: #333; position: absolute; top: -9999px; left: -9999px; }
        
        /* PDF Header Layout */
        .pdf-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .pdf-logo { height: 50px; width: auto; display: block; object-fit: contain; }
        .pdf-meta { text-align: right; font-size: 14px; color: #555; line-height: 1.6; }
        .pdf-title-row { margin-bottom: 20px; }
        .pdf-doc-title { font-size: 24px; font-weight: 800; color: #2c3e50; margin: 0; text-transform: uppercase; letter-spacing: 1px; }

        .pdf-section { font-size: 16px; font-weight: bold; margin: 25px 0 10px; color: #444; text-transform: uppercase; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .pdf-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .pdf-th { background: #f8f9fa; color: #555; text-align: left; padding: 8px; border-bottom: 2px solid #ddd; font-weight: 600; }
        .pdf-td { padding: 8px; border-bottom: 1px solid #eee; }
        .pdf-total-row td { font-weight: bold; background-color: #fdfdfd; border-top: 2px solid #ddd; color: #000; padding: 10px; }
        .badge-inc { background: #e6f4ea; color: #1e7e34; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; }

        /* OVERLAY LOADER */
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; text-align: center; padding-top: 250px; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; display: inline-block; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div class="text-xl font-bold text-slate-700">Loading Inventory...</div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-12 min-h-screen text-slate-600">
    <div class="relative lg:col-span-8 lg:p-12 p-6 xl:col-span-9" id="formContainer">
        <header class="flex justify-between border-slate-200 border-b items-start max-w-4xl mb-6 pb-6">
            <div>
                <h1 class="font-extrabold text-4xl text-slate-900 tracking-tight">Solution Designer</h1>
                <p class="mt-2 text-slate-500 text-lg">Lead Quick Quote</p>
            </div>
            <div class="text-right">
                <div id="recordNameDisplay" class="font-bold text-slate-700">Lead: ...</div>
                <div id="dateDisplay" class="text-xs text-slate-400 font-mono mt-1">Date: --</div>
            </div>
        </header>

        <div class="max-w-4xl space-y-8">
            
            <div class="section-card">
                <div class="step-header"><div><h2 class="step-title">User Licenses</h2></div><span class="step-subtitle">Step 01</span></div>
                <div class="space-y-4">
                    <div class="flex items-center justify-between input-group">
                        <div class="pr-4"><label class="label-main">Standard Users</label><span class="label-sub">Common areas, lobby phones.</span></div>
                        <div class="flex flex-col items-end"><input class="calc-trigger input-clean license-trigger" type="number" id="standardUsers" placeholder="0" min="0"><span class="price-tag" id="price_stdUser">...</span></div>
                    </div>
                    <div class="flex items-center justify-between input-group">
                        <div class="pr-4"><label class="label-main">Advanced Users</label><span class="label-sub">Office staff, sales, remote.</span></div>
                        <div class="flex flex-col items-end"><input class="calc-trigger input-clean license-trigger" type="number" id="advancedUsers" placeholder="0" min="0"><span class="price-tag" id="price_advUser">...</span></div>
                    </div>
                    <div class="flex items-center justify-between input-group border-l-4 border-l-indigo-500">
                        <div class="pr-4"><label class="label-main text-indigo-900">Contact Center Agents</label><span class="label-sub text-indigo-700/70">Queues & Analytics.</span></div>
                        <div class="flex flex-col items-end"><input class="calc-trigger input-clean license-trigger border-indigo-200" type="number" id="ccAgents" placeholder="0" min="0"><span class="price-tag text-indigo-600" id="price_ccAgent">...</span></div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="step-header"><div><h2 class="step-title">Connectivity & Numbers</h2></div><span class="step-subtitle">Step 02</span></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="border rounded-lg p-4 bg-slate-50">
                        <h3 class="font-bold text-xs tracking-wider uppercase mb-3 text-slate-400">Local DIDs</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center"><label class="text-sm">Porting</label><input class="calc-trigger input-clean w-20" type="number" id="portLocal" placeholder="Qty" min="0"></div>
                            <div class="flex justify-between items-center"><label class="text-sm">New ($1)</label><input class="calc-trigger input-clean w-20" type="number" id="newLocal" placeholder="Qty" min="0"></div>
                        </div>
                    </div>
                    <div class="border rounded-lg p-4 bg-slate-50">
                        <h3 class="font-bold text-xs tracking-wider uppercase mb-3 text-slate-400">Toll-Free</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center"><label class="text-sm">Porting</label><input class="calc-trigger input-clean w-20 tf-trigger" type="number" id="portTF" placeholder="Qty" min="0"></div>
                            <div class="flex justify-between items-center"><label class="text-sm">New ($2)</label><input class="calc-trigger input-clean w-20 tf-trigger" type="number" id="newTF" placeholder="Qty" min="0"></div>
                        </div>
                    </div>
                </div>

                <div id="tfMinutesRow" class="hidden flex items-center justify-between border-l-4 border-blue-500 bg-blue-50 p-4 rounded mb-6">
                    <div><label class="font-bold text-sm text-blue-900">Est. Monthly TF Minutes</label></div>
                    <div class="flex flex-col items-end">
                         <input class="calc-trigger input-clean w-24 border-blue-200" type="number" id="tfMinutes" placeholder="0" min="0">
                         <span class="text-[10px] text-blue-500 font-bold mt-1">$15/500min bundle</span>
                    </div>
                </div>

                <div class="border rounded-lg p-4 bg-slate-50">
                    <label class="flex cursor-pointer items-center justify-between">
                        <span class="font-bold text-sm text-slate-800">Enable SIP Trunking?</span>
                        <div class="relative items-center">
                            <input class="calc-trigger sr-only" type="checkbox" id="sipTrunkingToggle">
                            <div class="rounded-full duration-200 ease-in-out bg-slate-200 h-6 shadow-inner transition-colors w-10" id="sipTrack"></div>
                            <div class="rounded-full duration-200 ease-in-out absolute bg-white h-4 left-1 shadow top-1 transition-transform w-4" id="sipDot"></div>
                        </div>
                    </label>
                    <div class="hidden mt-4 pt-4 border-t border-slate-200" id="sipDetails">
                        <div class="flex justify-between items-center">
                            <label class="text-sm">Call Paths (Channels)</label>
                            <input class="input-clean calc-trigger" type="number" id="sipChannels" placeholder="0" min="0">
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="step-header"><div><h2 class="step-title">Hardware</h2></div><span class="step-subtitle">Step 03</span></div>
                
                <div class="flex items-center justify-between bg-slate-50 border border-slate-200 p-4 rounded mb-6">
                    <div><span class="font-bold text-sm text-slate-800">Customer Provided PoE?</span><span class="block text-xs text-slate-500">If unchecked, PSUs are MANDATORY.</span></div>
                    <input class="calc-trigger w-5 h-5" type="checkbox" id="customerPoE" checked>
                </div>

                <div class="grid gap-4 grid-cols-2 lg:grid-cols-4">
                    <div class="flex flex-col">
                        <label class="font-bold text-sm text-center mb-1">Basic Phone</label>
                        <span class="text-[10px] text-center text-slate-400 mb-2" id="price_hwBasic">...</span>
                        <input class="calc-trigger input-col parent-hw phone-unit" type="number" id="hwBasic" placeholder="0" min="0">
                        <div class="acc-panel">
                            <div class="mb-2"><span class="acc-label">Mount</span><input class="calc-trigger acc-input acc-validate" type="number" id="mount_basic" placeholder="0" min="0" data-parent="hwBasic"></div>
                            <div><span class="acc-label">PSU</span><input class="calc-trigger acc-input acc-validate psu-unit" type="number" id="psu_basic" placeholder="0" min="0" data-parent="hwBasic"></div>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="font-bold text-sm text-center mb-1">Office Phone</label>
                        <span class="text-[10px] text-center text-slate-400 mb-2" id="price_hwOffice">...</span>
                        <input class="calc-trigger input-col parent-hw phone-unit" type="number" id="hwOffice" placeholder="0" min="0">
                        <div class="acc-panel">
                            <div class="mb-2"><span class="acc-label">Mount</span><input class="calc-trigger acc-input acc-validate" type="number" id="mount_office" placeholder="0" min="0" data-parent="hwOffice"></div>
                            <div><span class="acc-label">PSU</span><input class="calc-trigger acc-input acc-validate psu-unit" type="number" id="psu_office" placeholder="0" min="0" data-parent="hwOffice"></div>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="font-bold text-sm text-center mb-1">Exec Phone</label>
                        <span class="text-[10px] text-center text-slate-400 mb-2" id="price_hwExec">...</span>
                        <input class="calc-trigger input-col parent-hw phone-unit" type="number" id="hwExec" placeholder="0" min="0">
                        <div class="acc-panel">
                            <div class="mb-2"><span class="acc-label">Mount</span><input class="calc-trigger acc-input acc-validate" type="number" id="mount_exec" placeholder="0" min="0" data-parent="hwExec"></div>
                            <div><span class="acc-label">PSU</span><input class="calc-trigger acc-input acc-validate psu-unit" type="number" id="psu_exec" placeholder="0" min="0" data-parent="hwExec"></div>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="font-bold text-sm text-center mb-1">Conf Phone</label>
                        <span class="text-[10px] text-center text-slate-400 mb-2" id="price_hwConf">...</span>
                        <input class="calc-trigger input-col phone-unit" type="number" id="hwConf" placeholder="0" min="0">
                        <div class="acc-panel">
                            <div class="mb-2"><span class="acc-label">Mics</span><input class="calc-trigger acc-input" type="number" id="hwConfMics" placeholder="0" min="0"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-6 pt-6 border-t border-slate-100">
                    <div>
                        <label class="label-main">Cordless Handsets</label>
                        <span class="label-sub">Auto-calculates Base Kits.</span>
                        <input class="calc-trigger input-clean w-full phone-unit" type="number" id="hwCordless" placeholder="Qty" min="0">
                    </div>
                    <div>
                        <label class="label-main">Sidecars</label>
                        <span class="label-sub">Requires Power Supply (Auto-added).</span>
                        <input class="calc-trigger input-clean w-full" type="number" id="sidecars" placeholder="Qty" min="0">
                    </div>
                </div>
                
                <div class="mt-4 border-t pt-4">
                     <label class="label-main">Headsets</label>
                     <input class="calc-trigger input-clean" type="number" id="hwHeadsets" placeholder="Qty" min="0">
                </div>
            </div>

            <div class="section-card">
                 <div class="step-header"><div><h2 class="step-title">Analog & Digital</h2></div><span class="step-subtitle">Step 04</span></div>
                 <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                     <div class="border rounded-lg p-4 bg-emerald-50 border-emerald-100">
                         <div class="flex items-center justify-between mb-2"><label class="font-bold text-sm text-emerald-800">E-Fax (Webfax)</label><span class="text-xs font-bold text-emerald-600" id="price_webfax">...</span></div>
                         <input class="calc-trigger input-clean w-full border-emerald-200 license-trigger" type="number" id="efaxQty" placeholder="Qty" min="0">
                     </div>
                     <div class="border rounded-lg p-4 bg-red-50 border-red-100">
                         <div class="flex items-center justify-between mb-2"><label class="font-bold text-sm text-red-800">POTS Replacement</label><span class="text-xs font-bold text-red-600" id="price_pots">...</span></div>
                         <input class="calc-trigger input-clean w-full border-red-200 license-trigger" type="number" id="physicalFaxQty" placeholder="Qty" min="0">
                     </div>
                 </div>
                 
                 <div class="mt-4 border rounded-lg p-4 bg-amber-50 border-amber-100 flex justify-between items-center">
                     <div>
                         <label class="font-bold text-sm text-amber-800">Paging/Analog Extensions</label>
                         <span class="block text-xs text-amber-600">Requires Site Survey</span>
                     </div>
                     <input class="calc-trigger input-clean border-amber-200 license-trigger" type="number" id="pagingQty" placeholder="Qty" min="0">
                 </div>
            </div>

        </div>
    </div>

    <div class="flex flex-col bg-slate-900 h-screen lg:col-span-4 lg:p-8 overflow-y-auto p-6 shadow-2xl sticky top-0 xl:col-span-3 text-slate-300">
        <div class="border-slate-700 border-b mb-8 pb-6">
            <h2 class="font-bold text-white text-xl tracking-wide">Quote Summary</h2>
            <div class="text-xs text-slate-500 tracking-wider uppercase font-mono mt-1">Lead Estimation</div>
        </div>
        
        <div class="flex-1 space-y-6">
            <div>
                <h3 class="font-bold text-xs tracking-wider uppercase mb-3 text-slate-500">Monthly Recurring</h3>
                <div class="space-y-1" id="mrcList"><div class="text-sm italic text-slate-600">No items...</div></div>
                <div class="flex items-center justify-between border-slate-700 border-t mt-3 pt-3"><span class="text-sm text-slate-400">Total MRC</span><span class="font-bold text-lg text-blue-400" id="totalMRC">$0.00</span></div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Deployment</span>
                    <span class="bg-slate-700 text-slate-300 text-[10px] font-bold px-2 py-0.5 rounded-full" id="totalDeviceCount">0 Devices</span>
                </div>
                
                <div class="flex items-center justify-between mt-2 pt-2 border-t border-slate-700/50">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="includeInstall" class="calc-trigger rounded text-blue-500 bg-slate-700 border-slate-600">
                        <span class="text-sm font-bold text-slate-200">Include Install?</span>
                    </label>
                    <span class="text-[10px] font-bold text-slate-500" id="installStatus">OPTIONAL</span>
                </div>
                <div id="deployMsg" class="text-[10px] text-right text-slate-500 mt-1"></div>
            </div>

            <div>
                <h3 class="font-bold text-xs tracking-wider uppercase mb-3 text-slate-500">One-Time Costs</h3>
                <div class="space-y-1" id="otcList"><div class="text-sm italic text-slate-600">No items...</div></div>
                <div class="flex items-center justify-between border-slate-700 border-t mt-3 pt-3"><span class="text-sm text-slate-400">Total OTC</span><span class="font-bold text-lg text-orange-400" id="totalOTC">$0.00</span></div>
            </div>
            
            <div id="licenseError" class="hidden bg-red-900/90 border border-red-500 p-3 rounded text-sm text-red-100 mt-4">
                <div class="font-bold flex items-center gap-2">
                    <span>&#9888; Invalid Configuration</span>
                </div>
                <div class="mt-1 text-xs opacity-80">Phone count (<span id="errEndCount">0</span>) exceeds License count (<span id="errLicCount">0</span>).</div>
                <button onclick="overrideLock()" class="mt-3 w-full text-xs bg-red-800 hover:bg-red-700 border border-red-600 py-1 rounded">Unlock / Override</button>
            </div>
        </div>

        <div class="border-slate-700 border-t mt-8 pt-6">
            <button onclick="handleSaveToNotes()" class="flex items-center font-bold bg-green-600 gap-3 hover:bg-green-500 justify-center px-4 py-4 rounded-lg shadow-lg text-white w-full transition-all" id="btnSave">
                <span>Save to Notes</span>
                <span class="text-xl">&#43;</span>
            </button>
            <button onclick="downloadPDF()" class="w-full mt-3 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded text-xs uppercase" id="btnPdf">Download PDF</button>
        </div>
        <div class="text-center mt-2 text-xs text-green-400 opacity-0 transition-opacity" id="saveFeedback">Saved Successfully!</div>
    </div>
</div>

<div id="pdfTemplate" class="pdf-container">
    <div class="pdf-header-row">
        <img id="pdfLogoImg" class="pdf-logo" alt="VoiceOS" crossorigin="anonymous">
        
        <div class="pdf-meta">
            <div id="pdfLeadName" style="font-weight: bold; color:#444;">Lead Name</div>
            <div id="pdfDate">Date: --/--/----</div>
            <div id="pdfRefId" style="font-family: monospace; font-size: 12px; margin-top: 4px;">Ref: --</div>
        </div>
    </div>
    
    <div class="pdf-title-row">
        <h2 class="pdf-doc-title">Configuration Quote</h2>
    </div>

    <div class="pdf-section">Monthly Recurring Charges (MRC)</div>
    <table class="pdf-table">
        <thead><tr><th class="pdf-th">Item</th><th class="pdf-th" style="width:60px;text-align:center">Qty</th><th class="pdf-th" style="text-align:right">Rate</th><th class="pdf-th" style="text-align:right">Total</th></tr></thead>
        <tbody id="pdfMrcBody"></tbody>
        <tfoot><tr class="pdf-total-row"><td colspan="3" style="text-align:right;">TOTAL MONTHLY:</td><td style="text-align:right;" id="pdfMrcTotal">$0.00</td></tr></tfoot>
    </table>
    
    <div class="pdf-section">One-Time Charges (NRC)</div>
    <table class="pdf-table">
        <thead><tr><th class="pdf-th">Item</th><th class="pdf-th" style="width:60px;text-align:center">Qty</th><th class="pdf-th" style="text-align:right">Rate</th><th class="pdf-th" style="text-align:right">Total</th></tr></thead>
        <tbody id="pdfNrcBody"></tbody>
        <tfoot><tr class="pdf-total-row"><td colspan="3" style="text-align:right;">TOTAL ONE-TIME:</td><td style="text-align:right;" id="pdfNrcTotal">$0.00</td></tr></tfoot>
    </table>
</div>

<script>
    // --- STATE ---
    let PRICES = { 
        stdUser:21, stdSetup:12, advUser:29, advSetup:14, ccAgent:55, ccSetup:25,
        potsLine:32, potsSetup:126, ata:45,
        webfax:14, webfaxSetup:14,
        paging:32, pagingSetup:126, pagingSurvey:169,
        hwBasic:139, hwOffice:165, hwExec:205, hwConf:630, hwCordlessBase:129, hwCordlessHandset:129,
        hwWallMount:10, hwPowerSupply:15, sidecar:125, sidecarPSU:15,
        deployHourly:200, sipChannel:24.99, sipSetup:15
    };
    
    const FEES = { newLocalSetup: 1.00, newTFSetup: 2.00, excessDID: 1.00, tfMRC: 1.00, tfBundle: 15.00 };
    const LOGO_URL = "https://bartow-voiceos.zohosites.com/Logos/PoweredBy_SMALL.png";

    let LEAD_ID = "00000";
    let LEAD_NAME = "Lead";
    let OVERRIDE_LOCK = false;
    let QUOTE_DATA = { mrc:[], nrc:[] };

    // --- INIT ---
    ZOHO.embeddedApp.on("PageLoad", function(data){
        if(data && data.EntityId) {
            LEAD_ID = Array.isArray(data.EntityId) ? data.EntityId[0] : data.EntityId;
            initWidget();
        }
    });
    ZOHO.embeddedApp.init();

    async function initWidget() {
        document.getElementById('dateDisplay').innerText = "Date: " + new Date().toLocaleDateString();
        showLoader(true);
        try {
            let l = await ZOHO.CRM.API.getRecord({ Entity: "Leads", RecordID: LEAD_ID });
            if(l.data) {
                let d = l.data[0];
                LEAD_NAME = (d.First_Name ? d.First_Name + " " : "") + d.Last_Name;
                document.getElementById('recordNameDisplay').innerText = "Lead: " + LEAD_NAME;
            }
            let prod = await ZOHO.CRM.API.getAllRecords({ Entity: "Products", sort_order: "asc", per_page: 200 });
            if(prod.data) updatePrices(prod.data);
        } catch(e){ console.error(e); }
        
        showLoader(false);
        calculateTotals();
    }

    function updatePrices(products) {
        const get = (cat, type, sku) => {
            let m = products.filter(p=>p.Product_Active);
            if(sku) m = m.filter(p=>p.Product_Code===sku);
            else if(cat) m = m.filter(p=>p.CF_CRM_Category===cat || p.Product_Category===cat);
            if(type && !sku) m = m.filter(p=>p.CF_Software_Type===type || p.CF_Hardware_Type===type);
            m.sort((a,b)=>(a.Unit_Price||0)-(b.Unit_Price||0));
            return m.length ? (m[0].Unit_Price||0) : null;
        };
        
        let p;
        if(p=get('VoiceOS','VoiceOS STD')) PRICES.stdUser=p;
        if(p=get(null,null,'Onboarding_VoiceOS-STD')) PRICES.stdSetup=p;
        if(p=get('VoiceOS','VoiceOS ADV')) PRICES.advUser=p;
        if(p=get(null,null,'Onboarding_VoiceOS-ADV')) { PRICES.advSetup=p; PRICES.webfaxSetup=p; }
        if(p=get('VoiceOS','VoiceOS CC')) PRICES.ccAgent=p;
        if(p=get(null,null,'Onboarding_VoiceOS-CC')) PRICES.ccSetup=p;
        if(p=get('Standard Phones')) PRICES.hwBasic=p;
        if(p=get('Office Phones')) PRICES.hwOffice=p;
        if(p=get('Executive Phones')) PRICES.hwExec=p;
        if(p=get('Conference Phones')) PRICES.hwConf=p;
        if(p=get('Cordless Phones','Cordless Base')) PRICES.hwCordlessBase=p;
        if(p=get('Cordless Phones','Cordless Handset')) PRICES.hwCordlessHandset=p;
        if(p=get('Phone Misc','Wall Mount')) PRICES.hwWallMount=p;
        if(p=get('Phone Misc','Power Supply')) PRICES.hwPowerSupply=p;
        if(p=get('Phone Misc','Sidecar')) PRICES.sidecar=p;
        if(p=get(null,null,'AMP_PS_STD_FC')) PRICES.deployHourly=p;
        if(p=get(null,null,'AMP_PS_SVY_FC')) PRICES.pagingSurvey=p;
        if(p=get(null,null,'Onboarding_VoiceOS-POTS')) PRICES.potsSetup=p;
        
        setText('price_stdUser', `$${PRICES.stdUser}/mo`);
        setText('price_advUser', `$${PRICES.advUser}/mo`);
        setText('price_ccAgent', `$${PRICES.ccAgent}/mo`);
        setText('price_hwBasic', `$${PRICES.hwBasic}`);
        setText('price_hwOffice', `$${PRICES.hwOffice}`);
        setText('price_hwExec', `$${PRICES.hwExec}`);
    }

    // --- UI EVENTS ---
    document.querySelectorAll('.calc-trigger').forEach(e => e.addEventListener('input', calculateTotals));
    document.querySelectorAll('.tf-trigger').forEach(e => e.addEventListener('input', () => {
        const totalTF = val('portTF') + val('newTF');
        document.getElementById('tfMinutesRow').classList.toggle('hidden', totalTF <= 0);
        calculateTotals();
    }));
    document.getElementById('sipTrunkingToggle').addEventListener('change', (e) => {
        document.getElementById('sipDetails').classList.toggle('hidden', !e.target.checked);
        const t=document.getElementById('sipTrack'), d=document.getElementById('sipDot');
        if(e.target.checked){ t.classList.remove('bg-slate-200'); t.classList.add('bg-blue-500'); d.classList.add('translate-x-full'); }
        else { t.classList.add('bg-slate-200'); t.classList.remove('bg-blue-500'); d.classList.remove('translate-x-full'); }
        calculateTotals();
    });
    document.getElementById('customerPoE').addEventListener('change', updatePowerSupplies);
    document.querySelectorAll('.acc-validate').forEach(el => el.addEventListener('input', (e) => {
        const max = val(e.target.dataset.parent);
        if(val(e.target.id) > max) e.target.value = max;
        calculateTotals();
    }));

    function updatePowerSupplies() {
        const poe = document.getElementById('customerPoE').checked;
        document.querySelectorAll('.psu-unit').forEach(el => {
            const parent = val(el.dataset.parent);
            if(!poe) {
                el.value = parent > 0 ? parent : '';
                el.setAttribute('readonly', true);
                el.classList.add('bg-gray-100','text-gray-500');
            } else {
                el.removeAttribute('readonly');
                el.classList.remove('bg-gray-100','text-gray-500');
            }
        });
        calculateTotals();
    }
    
    function overrideLock() {
        OVERRIDE_LOCK = true;
        document.getElementById('licenseError').classList.add('hidden');
        toggleButtons(true);
    }

    // --- CALCULATOR ---
    function calculateTotals() {
        QUOTE_DATA = { mrc: [], nrc: [] };
        let mrcT = 0, nrcT = 0;

        const addMrc = (name, qty, rate, entitlement) => {
            if(qty<=0) return;
            mrcT += qty*rate;
            QUOTE_DATA.mrc.push({ name, qty, rate, total: qty*rate, entitlement });
        };
        const addNrc = (name, qty, rate) => {
            if(qty<=0) return;
            nrcT += qty*rate;
            QUOTE_DATA.nrc.push({ name, qty, rate, total: qty*rate });
        };

        const std = val('standardUsers');
        addMrc('Standard User', std, PRICES.stdUser); addNrc('Setup: Standard User', std, PRICES.stdSetup);
        
        const adv = val('advancedUsers');
        addMrc('Advanced User', adv, PRICES.advUser); addNrc('Setup: Advanced User', adv, PRICES.advSetup);
        
        const cc = val('ccAgents');
        addMrc('CC Agent', cc, PRICES.ccAgent); addNrc('Setup: CC Agent', cc, PRICES.ccSetup);

        const webfax = val('efaxQty');
        addMrc('Webfax', webfax, PRICES.webfax); addNrc('Setup: Webfax', webfax, PRICES.webfaxSetup);
        
        const pots = val('physicalFaxQty'); 
        if(pots > 0) {
            addMrc('POTS Replacement', pots, PRICES.potsLine);
            addNrc('Setup: POTS Rep', pots, PRICES.potsSetup);
            addNrc('ATA Device', pots, PRICES.ata);
        }
        
        const paging = val('pagingQty');
        if(paging > 0) {
            addMrc('Paging/Analog Ext', paging, PRICES.potsLine); 
            addNrc('Setup: Paging', paging, PRICES.pagingSetup); 
            addNrc('ATA Device', paging, PRICES.ata);
        }

        const totalEntitlements = std + adv + cc + webfax + pots + paging;
        const totalLocal = val('portLocal') + val('newLocal');
        
        const freeLocal = Math.min(totalLocal, totalEntitlements);
        const billableLocal = Math.max(0, totalLocal - totalEntitlements);
        
        if(freeLocal > 0) addMrc('Local DID (Included)', freeLocal, 0, true);
        if(billableLocal > 0) addMrc('Local DID (Excess)', billableLocal, FEES.excessDID);
        
        if(val('newLocal') > 0) addNrc('New DID Activation', val('newLocal'), FEES.newLocalSetup);
        
        const totalTF = val('portTF') + val('newTF');
        if(totalTF > 0) addMrc('Toll-Free Number', totalTF, FEES.tfMRC);
        if(val('newTF') > 0) addNrc('New TF Activation', val('newTF'), FEES.newTFSetup);
        
        if(totalTF > 0 && val('tfMinutes') > 0) {
            const bundles = Math.ceil(val('tfMinutes') / 500);
            addMrc('Toll-Free Minutes Bundle', bundles, FEES.tfBundle);
        }

        addNrc('Basic Phone', val('hwBasic'), PRICES.hwBasic);
        addNrc('Office Phone', val('hwOffice'), PRICES.hwOffice);
        addNrc('Exec Phone', val('hwExec'), PRICES.hwExec);
        addNrc('Conf Phone', val('hwConf'), PRICES.hwConf);
        addNrc('Exp Mics', val('hwConfMics'), 220);
        addNrc('Headsets', val('hwHeadsets'), 185);
        
        const cord = val('hwCordless');
        if(cord > 0) {
            const kits = Math.ceil(cord / 10);
            const extra = Math.max(0, cord - kits);
            addNrc('Cordless Base Kit', kits, PRICES.hwCordlessBase);
            addNrc('Cordless Handset', extra, PRICES.hwCordlessHandset);
        }
        
        const mounts = val('mount_basic')+val('mount_office')+val('mount_exec');
        addNrc('Wall Mount', mounts, PRICES.hwWallMount);
        
        const psus = val('psu_basic')+val('psu_office')+val('psu_exec');
        addNrc('Power Supply', psus, PRICES.hwPowerSupply);
        
        const side = val('sidecars');
        if(side > 0) {
            addNrc('Sidecar', side, PRICES.sidecar);
            addNrc('Sidecar PSU', side, PRICES.sidecarPSU);
        }

        const totalPhones = val('hwBasic')+val('hwOffice')+val('hwExec')+val('hwConf')+val('hwCordless');
        const totalATAs = pots + paging;
        const totalDevices = totalPhones + totalATAs + side;
        
        document.getElementById('totalDeviceCount').innerText = `${totalDevices} Devices`;
        
        const installCb = document.getElementById('includeInstall');
        const installStatus = document.getElementById('installStatus');
        
        if(totalATAs > 0) {
            installCb.checked = true; installCb.disabled = true;
            installStatus.innerText = "MANDATORY (ATA)"; installStatus.className = "text-[10px] font-bold text-orange-500";
        } else {
            installCb.disabled = (totalDevices === 0);
            installStatus.innerText = "OPTIONAL"; installStatus.className = "text-[10px] font-bold text-slate-500";
        }
        
        if(installCb.checked && totalDevices > 0) {
            const hours = Math.ceil(totalDevices / 5);
            addNrc(`On-Site Labor (${hours} hrs)`, hours, PRICES.deployHourly);
            document.getElementById('deployMsg').innerText = `${hours} Hours @ $${PRICES.deployHourly}/hr`;
        } else {
            document.getElementById('deployMsg').innerText = "";
        }
        
        if(paging > 0) addNrc('Site Survey', 1, PRICES.pagingSurvey);
        
        if(document.getElementById('sipTrunkingToggle').checked) {
            addMrc('SIP Channel', val('sipChannels'), PRICES.sipChannel);
            addNrc('SIP Activation', 1, PRICES.sipSetup);
        }

        document.getElementById('totalMRC').innerText = `$${mrcT.toFixed(2)}`;
        document.getElementById('totalOTC').innerText = `$${nrcT.toFixed(2)}`;
        
        renderSummaryList('mrcList', QUOTE_DATA.mrc);
        renderSummaryList('otcList', QUOTE_DATA.nrc);
        
        const totalSeats = std + adv + cc;
        if(!OVERRIDE_LOCK && totalPhones > totalSeats) {
            document.getElementById('licenseError').classList.remove('hidden');
            document.getElementById('errEndCount').innerText = totalPhones;
            document.getElementById('errLicCount').innerText = totalSeats;
            toggleButtons(false);
        } else {
            document.getElementById('licenseError').classList.add('hidden');
            toggleButtons(true);
        }
    }

    function toggleButtons(enable) {
        const ids = ['btnSave', 'btnPdf'];
        ids.forEach(id => {
            const btn = document.getElementById(id);
            btn.disabled = !enable;
            if(enable) btn.classList.remove('opacity-50', 'cursor-not-allowed');
            else btn.classList.add('opacity-50', 'cursor-not-allowed');
        });
    }

    function renderSummaryList(id, items) {
        const html = items.map(i => `
            <div class="summary-row">
                <span class="summary-label w-2/3 truncate">${i.name} (${i.qty})</span>
                <span class="summary-val">$${i.total.toFixed(2)}</span>
            </div>
        `).join('');
        document.getElementById(id).innerHTML = html || '<div class="text-sm italic text-slate-600">No items...</div>';
    }

    async function downloadPDF() {
        // 1. Prepare Unique ID
        const dateObj = new Date();
        const dateStr = dateObj.getFullYear() +
                        ('0' + (dateObj.getMonth()+1)).slice(-2) +
                        ('0' + dateObj.getDate()).slice(-2) +
                        ('0' + dateObj.getHours()).slice(-2) +
                        ('0' + dateObj.getMinutes()).slice(-2);
        const shortId = (LEAD_ID || "00000").slice(-5);
        const uniqueRef = `Ref: ${shortId}${dateStr}`;
        document.getElementById('pdfRefId').innerText = uniqueRef;

        // 2. Prepare Template
        document.getElementById('pdfLeadName').innerText = LEAD_NAME;
        document.getElementById('pdfDate').innerText = "Date: " + new Date().toLocaleDateString();
        
        const fillTable = (bodyId, items) => {
            document.getElementById(bodyId).innerHTML = items.map(i => `
                <tr>
                    <td class="pdf-td">${i.name}${i.entitlement ? "<span class='badge-inc'>Included</span>" : ""}</td>
                    <td class="pdf-td" style="text-align:center">${i.qty}</td>
                    <td class="pdf-td" style="text-align:right">$${i.rate.toFixed(2)}</td>
                    <td class="pdf-td" style="text-align:right">$${i.total.toFixed(2)}</td>
                </tr>
            `).join('');
        };
        fillTable('pdfMrcBody', QUOTE_DATA.mrc);
        fillTable('pdfNrcBody', QUOTE_DATA.nrc);
        document.getElementById('pdfMrcTotal').innerText = document.getElementById('totalMRC').innerText;
        document.getElementById('pdfNrcTotal').innerText = document.getElementById('totalOTC').innerText;
        
        // 3. Logo Magic (Pre-fetch to bypass CORS issues if possible)
        const imgEl = document.getElementById('pdfLogoImg');
        try {
             const base64 = await convertImgToBase64(LOGO_URL);
             imgEl.src = base64; 
        } catch(e) {
             console.warn("Logo CORS blocked, using direct URL as fallback");
             imgEl.src = LOGO_URL;
        }

        // 4. Generate
        const element = document.getElementById('pdfTemplate');
        const canvas = await html2canvas(element, { scale: 2, useCORS: true, allowTaint: true });
        const imgData = canvas.toDataURL('image/jpeg', 0.98);
        const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`Quote_${LEAD_NAME.replace(/[^a-z0-9]/gi, '_')}.pdf`);
    }

    // Helper to fetch image data
    function convertImgToBase64(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL('image/png'));
            };
            img.onerror = reject;
            img.src = url;
        });
    }

    function handleSaveToNotes() {
        const btn = document.getElementById('btnSave');
        const oldText = btn.innerHTML;
        btn.innerText = "Saving..."; btn.disabled = true;
        
        const summary = `VOICEOS CONFIG - ${new Date().toLocaleDateString()}\n--------------------------------\n` +
            `MRC TOTAL: ${document.getElementById('totalMRC').innerText}\n` +
            `OTC TOTAL: ${document.getElementById('totalOTC').innerText}\n\n` +
            `[MRC ITEMS]\n` + QUOTE_DATA.mrc.map(i => `- ${i.qty}x ${i.name} @ $${i.rate}`).join('\n') + 
            `\n\n[NRC ITEMS]\n` + QUOTE_DATA.nrc.map(i => `- ${i.qty}x ${i.name} @ $${i.rate}`).join('\n');
            
        ZOHO.CRM.API.addRecord({ Entity: "Notes", APIData: { Parent_Id: LEAD_ID, Se_Module: "Leads", Note_Title: "Quote Config", Note_Content: summary } })
        .then(() => {
            btn.innerHTML = oldText; btn.disabled = false;
            const fb = document.getElementById('saveFeedback');
            fb.classList.remove('opacity-0'); setTimeout(()=>fb.classList.add('opacity-0'),2000);
        });
    }

    function val(id) { return parseFloat(document.getElementById(id).value) || 0; }
    function setText(id, t) { if(document.getElementById(id)) document.getElementById(id).innerText = t; }
    function showLoader(s) { document.getElementById('loader').style.display = s?'block':'none'; }
</script>
</body>
</html>
