<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceOS Lead Configurator</title>
    
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style type="text/tailwindcss">
        body{font-family:'Inter',sans-serif;background-color:#f8fafc}.section-card{@apply bg-white rounded-xl border border-slate-200 shadow-sm p-8 mb-8 transition-all duration-200}.section-card:hover{@apply shadow-md border-blue-200}.step-header{@apply mb-6 pb-4 border-b-2 border-slate-100 flex items-end justify-between}.step-title{@apply text-2xl font-extrabold text-slate-800 tracking-tight}.step-subtitle{@apply text-sm text-slate-400 font-medium uppercase tracking-wider mb-1}.input-group{@apply relative bg-slate-50 rounded-lg p-4 border border-slate-200 transition-colors focus-within:bg-white focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500}.label-main{@apply block text-sm font-semibold text-slate-700 mb-1}.label-sub{@apply block text-xs text-slate-500 mb-3}.input-clean{@apply w-24 text-right font-bold text-slate-800 bg-white border border-slate-300 rounded-md py-1.5 px-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all}.input-col{@apply w-full text-center font-bold text-slate-800 bg-white border border-slate-300 rounded-md py-2 px-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all}.price-tag{@apply text-xs font-medium text-slate-500 mt-1 block text-right}.toggle-checkbox:checked{@apply right-0 border-green-400}.toggle-checkbox:checked+.toggle-label{@apply bg-green-400}.summary-row{@apply flex justify-between text-sm py-2 border-b border-slate-700/50 last:border-0}.summary-label{@apply text-slate-400}.summary-val{@apply font-medium text-slate-200}.acc-panel{@apply mt-3 pt-3 border-t border-slate-100 bg-slate-50/50 rounded-b-lg px-1}.acc-label{@apply text-[10px] font-bold text-slate-400 mb-1 block uppercase tracking-wide text-center}.acc-input{@apply w-full text-xs border-slate-200 rounded p-1 text-center font-semibold focus:ring-1 focus:ring-blue-500 outline-none bg-white disabled:bg-slate-100 disabled:text-slate-400}
        
        /* OVERLAY LOADER */
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; text-align: center; padding-top: 250px; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; display: inline-block; margin-bottom: 15px; }
        #loaderText { font-size: 18px; color: #333; font-weight: 600; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div id="loaderText">Initializing...</div>
    <div id="loaderSubText" class="text-sm text-gray-500 mt-2">Loading Live Inventory...</div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-12 min-h-screen text-slate-600">
    <div class="relative lg:col-span-8 lg:p-12 p-6 xl:col-span-9" id="quoteContainer">
        <header class="flex justify-between border-slate-200 border-b items-start max-w-4xl mb-6 pb-6">
            <div>
                <h1 class="font-extrabold text-4xl text-slate-900 tracking-tight">Solution Designer</h1>
                <p class="mt-2 text-slate-500 text-lg">Lead Quick Quote</p>
            </div>
            <div class="text-right">
                <div id="recordNameDisplay" class="font-bold text-slate-700">Lead: ...</div>
                <div id="dateDisplay" class="text-xs text-slate-400 font-mono mt-1">Date: --</div>
            </div>
        </header>

        <div class="max-w-4xl space-y-8">
            
            <div class="section-card">
                <div class="step-header"><div><h2 class="step-title">User Licenses</h2></div><span class="step-subtitle">Step 01</span></div>
                <div class="space-y-4">
                    <div class="flex items-center justify-between input-group">
                        <div class="pr-4"><label class="label-main">Standard Users</label><span class="label-sub">Common areas, lobby phones.</span></div>
                        <div class="flex flex-col items-end"><input class="calc-trigger input-clean" type="number" id="standardUsers" placeholder="0" min="0"><span class="price-tag" id="price_stdUser">...</span></div>
                    </div>
                    <div class="flex items-center justify-between input-group">
                        <div class="pr-4"><label class="label-main">Advanced Users</label><span class="label-sub">Office staff, sales, remote.</span></div>
                        <div class="flex flex-col items-end"><input class="calc-trigger input-clean" type="number" id="advancedUsers" placeholder="0" min="0"><span class="price-tag" id="price_advUser">...</span></div>
                    </div>
                    <div class="flex items-center justify-between input-group border-l-4 border-l-indigo-500">
                        <div class="pr-4"><label class="label-main text-indigo-900">Contact Center Agents</label><span class="label-sub text-indigo-700/70">Queues & Analytics.</span></div>
                        <div class="flex flex-col items-end"><input class="calc-trigger input-clean border-indigo-200" type="number" id="ccAgents" placeholder="0" min="0"><span class="price-tag text-indigo-600" id="price_ccAgent">...</span></div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="step-header"><div><h2 class="step-title">Connectivity & Numbers</h2></div><span class="step-subtitle">Step 02</span></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="border rounded-lg p-4 bg-slate-50">
                        <h3 class="font-bold text-xs tracking-wider uppercase mb-3 text-slate-400">Local DIDs</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center"><label class="text-sm">Porting</label><input class="calc-trigger input-clean w-20" type="number" id="portLocal" placeholder="Qty"></div>
                            <div class="flex justify-between items-center"><label class="text-sm">New ($1)</label><input class="calc-trigger input-clean w-20" type="number" id="newLocal" placeholder="Qty"></div>
                        </div>
                    </div>
                    <div class="border rounded-lg p-4 bg-slate-50">
                        <h3 class="font-bold text-xs tracking-wider uppercase mb-3 text-slate-400">Toll-Free</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center"><label class="text-sm">Porting</label><input class="calc-trigger input-clean w-20" type="number" id="portTF" placeholder="Qty"></div>
                            <div class="flex justify-between items-center"><label class="text-sm">New ($1)</label><input class="calc-trigger input-clean w-20" type="number" id="newTF" placeholder="Qty"></div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between border-l-4 border-blue-500 bg-blue-50 p-4 rounded mb-6">
                    <div><label class="font-bold text-sm text-blue-900">Est. Monthly TF Minutes</label></div>
                    <div class="flex flex-col items-end">
                         <input class="calc-trigger input-clean w-24 border-blue-200" type="number" id="tfMinutes" placeholder="0">
                         <span class="text-[10px] text-blue-500 font-bold mt-1">$15/500min bundle</span>
                    </div>
                    <div id="tfCallout" class="hidden ml-2 text-xs text-blue-600 font-bold">Bundle Applied</div>
                </div>

                <div class="border rounded-lg p-4 bg-slate-50">
                    <label class="flex cursor-pointer items-center justify-between">
                        <span class="font-bold text-sm text-slate-800">Enable SIP Trunking?</span>
                        <div class="relative items-center">
                            <input class="calc-trigger sr-only" type="checkbox" id="sipTrunkingToggle">
                            <div class="rounded-full duration-200 ease-in-out bg-slate-200 h-6 shadow-inner transition-colors w-10" id="sipTrack"></div>
                            <div class="rounded-full duration-200 ease-in-out absolute bg-white h-4 left-1 shadow top-1 transition-transform w-4" id="sipDot"></div>
                        </div>
                    </label>
                    <div class="hidden mt-4 pt-4 border-t border-slate-200" id="sipDetails">
                        <div class="flex justify-between items-center">
                            <label class="text-sm">Call Paths (Channels)</label>
                            <input class="input-clean calc-trigger" type="number" id="sipChannels" placeholder="0">
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="step-header"><div><h2 class="step-title">Hardware</h2></div><span class="step-subtitle">Step 03</span></div>
                
                <div class="flex items-center justify-between bg-slate-50 border border-slate-200 p-4 rounded mb-6">
                    <div><span class="font-bold text-sm text-slate-800">Customer Provided PoE?</span><span class="block text-xs text-slate-500">If unchecked, PSUs are MANDATORY.</span></div>
                    <input class="calc-trigger w-5 h-5" type="checkbox" id="customerPoE" checked>
                </div>

                <div class="grid gap-4 grid-cols-2 lg:grid-cols-4">
                    <div class="flex flex-col">
                        <label class="font-bold text-sm text-center mb-1">Basic Phone</label>
                        <span class="text-[10px] text-center text-slate-400 mb-2" id="price_hwBasic">...</span>
                        <input class="calc-trigger input-col parent-hw" type="number" id="hwBasic" placeholder="0" data-type="basic">
                        <div class="acc-panel">
                            <div class="mb-2"><span class="acc-label">Mount</span><input class="calc-trigger acc-input acc-validate" type="number" id="mount_basic" placeholder="0" data-parent="hwBasic"></div>
                            <div><span class="acc-label">PSU</span><input class="calc-trigger acc-input acc-validate psu-unit" type="number" id="psu_basic" placeholder="0" data-parent="hwBasic"></div>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="font-bold text-sm text-center mb-1">Office Phone</label>
                        <span class="text-[10px] text-center text-slate-400 mb-2" id="price_hwOffice">...</span>
                        <input class="calc-trigger input-col parent-hw" type="number" id="hwOffice" placeholder="0" data-type="office">
                        <div class="acc-panel">
                            <div class="mb-2"><span class="acc-label">Mount</span><input class="calc-trigger acc-input acc-validate" type="number" id="mount_office" placeholder="0" data-parent="hwOffice"></div>
                            <div><span class="acc-label">PSU</span><input class="calc-trigger acc-input acc-validate psu-unit" type="number" id="psu_office" placeholder="0" data-parent="hwOffice"></div>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="font-bold text-sm text-center mb-1">Exec Phone</label>
                        <span class="text-[10px] text-center text-slate-400 mb-2" id="price_hwExec">...</span>
                        <input class="calc-trigger input-col parent-hw" type="number" id="hwExec" placeholder="0" data-type="exec">
                        <div class="acc-panel">
                            <div class="mb-2"><span class="acc-label">Mount</span><input class="calc-trigger acc-input acc-validate" type="number" id="mount_exec" placeholder="0" data-parent="hwExec"></div>
                            <div><span class="acc-label">PSU</span><input class="calc-trigger acc-input acc-validate psu-unit" type="number" id="psu_exec" placeholder="0" data-parent="hwExec"></div>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="font-bold text-sm text-center mb-1">Conf Phone</label>
                        <span class="text-[10px] text-center text-slate-400 mb-2" id="price_hwConf">...</span>
                        <input class="calc-trigger input-col" type="number" id="hwConf" placeholder="0">
                        <div class="acc-panel">
                            <div class="mb-2"><span class="acc-label">Mics</span><input class="calc-trigger acc-input" type="number" id="hwConfMics" placeholder="0"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-6 pt-6 border-t border-slate-100">
                    <div>
                        <label class="label-main">Cordless Handsets</label>
                        <span class="label-sub">Auto-calculates Base Kits (1 per 10).</span>
                        <div class="flex flex-col">
                             <input class="calc-trigger input-clean w-full" type="number" id="hwCordless" placeholder="Qty">
                             <span class="text-[10px] font-bold text-purple-600 mt-1 hidden" id="cordlessInfo">Base Stations Included</span>
                        </div>
                    </div>
                    <div>
                        <label class="label-main">Sidecars</label>
                        <span class="label-sub">Requires Power Supply (Auto-added).</span>
                        <input class="calc-trigger input-clean w-full" type="number" id="sidecars" placeholder="Qty">
                        <span class="text-[10px] font-bold text-orange-600 mt-1 hidden" id="sidecarPSUInfo">+PSUs Added</span>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-between items-center border-t pt-4">
                     <label class="label-main">Headsets</label>
                     <input class="calc-trigger input-clean" type="number" id="hwHeadsets" placeholder="Qty">
                </div>
            </div>

            <div class="section-card">
                 <div class="step-header"><div><h2 class="step-title">Analog & Digital</h2></div><span class="step-subtitle">Step 04</span></div>
                 <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                     <div class="border rounded-lg p-4 bg-emerald-50 border-emerald-100">
                         <div class="flex items-center justify-between mb-2"><label class="font-bold text-sm text-emerald-800">E-Fax (Webfax)</label><span class="text-xs font-bold text-emerald-600" id="price_webfax">...</span></div>
                         <input class="calc-trigger input-clean w-full border-emerald-200" type="number" id="efaxQty" placeholder="Qty">
                     </div>
                     <div class="border rounded-lg p-4 bg-red-50 border-red-100">
                         <div class="flex items-center justify-between mb-2"><label class="font-bold text-sm text-red-800">Physical Fax (Analog)</label><span class="text-xs font-bold text-red-600" id="price_pots">...</span></div>
                         <input class="calc-trigger input-clean w-full border-red-200" type="number" id="physicalFaxQty" placeholder="Qty">
                         <p class="mt-2 text-[10px] text-center text-red-600">Includes 1 ATA per Line</p>
                     </div>
                 </div>
                 
                 <div class="mt-4 border rounded-lg p-4 bg-amber-50 border-amber-100 flex justify-between items-center">
                     <div>
                         <label class="font-bold text-sm text-amber-800">Paging/Analog Extensions</label>
                         <span class="block text-xs text-amber-600">Requires Site Survey</span>
                     </div>
                     <input class="calc-trigger input-clean border-amber-200" type="number" id="pagingQty" placeholder="Qty">
                 </div>
            </div>
            
            <div class="flex items-center justify-between p-4 border rounded-lg">
                <label class="font-bold text-sm text-slate-700">Missing Floorplan?</label>
                <input class="calc-trigger w-5 h-5" type="checkbox" id="fpNo">
            </div>

        </div>
    </div>

    <div class="flex flex-col bg-slate-900 h-screen lg:col-span-4 lg:p-8 overflow-y-auto p-6 shadow-2xl sticky top-0 xl:col-span-3 text-slate-300">
        <div class="border-slate-700 border-b mb-8 pb-6">
            <h2 class="font-bold text-white text-xl tracking-wide">Quote Summary</h2>
            <div class="text-xs text-slate-500 tracking-wider uppercase font-mono mt-1">Lead Estimation</div>
        </div>
        
        <div class="flex-1 space-y-6">
            <div>
                <h3 class="font-bold text-xs tracking-wider uppercase mb-3 text-slate-500">Monthly Recurring</h3>
                <div class="space-y-1" id="mrcList"><div class="text-sm italic text-slate-600">No items...</div></div>
                <div class="flex items-center justify-between border-slate-700 border-t mt-3 pt-3"><span class="text-sm text-slate-400">Total MRC</span><span class="font-bold text-lg text-blue-400" id="totalMRC">$0.00</span></div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Deployment</span>
                    <span class="bg-slate-700 text-slate-300 text-[10px] font-bold px-2 py-0.5 rounded-full" id="totalDeviceCount">0 Devices</span>
                </div>
                <div id="deviceBreakdown" class="text-xs text-slate-400 mb-2"></div>
                
                <div class="flex items-center justify-between mt-2 pt-2 border-t border-slate-700/50">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="includeInstall" class="calc-trigger rounded text-blue-500 bg-slate-700 border-slate-600">
                        <span class="text-sm font-bold text-slate-200">Include Install?</span>
                    </label>
                    <span class="text-[10px] font-bold text-slate-500" id="installStatus">OPTIONAL</span>
                </div>
                <div id="deployMsg" class="text-[10px] text-right text-slate-500 mt-1"></div>
                <div id="deployFeeDisplay" class="hidden"></div> </div>

            <div>
                <h3 class="font-bold text-xs tracking-wider uppercase mb-3 text-slate-500">One-Time Costs</h3>
                <div class="space-y-1" id="otcList"><div class="text-sm italic text-slate-600">No items...</div></div>
                <div class="flex items-center justify-between border-slate-700 border-t mt-3 pt-3"><span class="text-sm text-slate-400">Total OTC</span><span class="font-bold text-lg text-orange-400" id="totalOTC">$0.00</span></div>
            </div>
            
            <div id="licenseError" class="hidden bg-red-900/50 border border-red-500 p-2 rounded text-xs text-red-200 mt-4">
                Warning: <span id="errEndCount"></span> Devices vs <span id="errLicCount"></span> Licenses.
            </div>
        </div>

        <div class="border-slate-700 border-t mt-8 pt-6">
            <button onclick="handleSaveToNotes()" class="flex items-center font-bold bg-green-600 gap-3 hover:bg-green-500 justify-center px-4 py-4 rounded-lg shadow-lg text-white w-full transition-all" id="btnSave">
                <span>Save to Lead Notes</span>
                <span class="text-xl">&#43;</span>
            </button>
            <button onclick="generatePDF()" class="w-full mt-3 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded text-xs uppercase">Download PDF</button>
        </div>
        <div class="text-center mt-2 text-xs text-green-400 opacity-0 transition-opacity" id="saveFeedback">Saved Successfully!</div>
    </div>
</div>

<script>
    // --- 1. STATE & CONSTANTS ---
    // Inherited from v7 but prices will be overwritten by Inventory Controller
    let PRICES = {
        stdUser:21,stdSetup:12,advUser:29,advSetup:14,ccAgent:55,ccSetup:25,
        sipChannel:24.99,sipSetup:15,
        newLocal:1,newLocalSetup:1,newTF:1,newTFSetup:2,
        sidecar:125,sidecarPSU:15,
        efax:14,efaxSetup:14,
        phyFaxLine:32,phyFaxConfig:126,potsLine:32,
        pagingConfig:126,pagingSurvey:169,
        hwBasic:139,hwOffice:165,hwExec:205,hwConf:630,hwConfMics:220,
        hwHeadsets:185,
        hwCordlessHandset:129,hwCordlessBase:129,
        ata:45,hwWallMount:10,hwPowerSupply:15,
        rec100:20,rec100Setup:8,rec500:70,rec500Setup:8
    };

    let LEAD_ID = null;
    let LEAD_NAME = "Lead";

    // --- 2. ZOHO INIT & INVENTORY ---
    ZOHO.embeddedApp.on("PageLoad", function(data){
        if(data && data.EntityId) {
            LEAD_ID = Array.isArray(data.EntityId) ? data.EntityId[0] : data.EntityId;
            initWidget();
        }
    });
    ZOHO.embeddedApp.init();

    async function initWidget() {
        document.getElementById('dateDisplay').innerText = "Date: " + new Date().toLocaleDateString();
        showLoader(true);

        try {
            // A. Fetch Lead Name
            let leadReq = await ZOHO.CRM.API.getRecord({ Entity: "Leads", RecordID: LEAD_ID });
            if(leadReq.data){
                let l = leadReq.data[0];
                LEAD_NAME = (l.First_Name ? l.First_Name + " " : "") + l.Last_Name;
                document.getElementById('recordNameDisplay').innerText = "Lead: " + LEAD_NAME;
            }

            // B. Fetch Inventory & Update PRICES
            let prodReq = await ZOHO.CRM.API.getAllRecords({ Entity: "Products", sort_order: "asc", per_page: 200 });
            if(prodReq.data) {
                updatePricesFromInventory(prodReq.data);
            }
        } catch(e) { console.error(e); }
        
        showLoader(false);
        calculateTotals();
    }

    function updatePricesFromInventory(products) {
        // Simple Lowest Price Finder Logic from previous step
        const find = (cat, type, sku) => {
            let matches = products.filter(p => p.Product_Active);
            if(sku) matches = matches.filter(p => p.Product_Code === sku);
            else if(cat) matches = matches.filter(p => p.CF_CRM_Category === cat || p.Product_Category === cat);
            
            if(type && !sku) matches = matches.filter(p => p.CF_Software_Type === type || p.CF_Hardware_Type === type);
            
            matches.sort((a,b) => (a.Unit_Price||0) - (b.Unit_Price||0));
            return matches.length > 0 ? (matches[0].Unit_Price||0) : null;
        };

        // Mapping Inventory to PRICES object
        let p;
        if(p = find('VoiceOS', 'VoiceOS STD')) PRICES.stdUser = p;
        if(p = find(null, null, 'Onboarding_VoiceOS-STD')) PRICES.stdSetup = p;
        
        if(p = find('VoiceOS', 'VoiceOS ADV')) PRICES.advUser = p;
        if(p = find(null, null, 'Onboarding_VoiceOS-ADV')) PRICES.advSetup = p; // Also Webfax Setup
        
        if(p = find('VoiceOS', 'VoiceOS CC')) PRICES.ccAgent = p;
        if(p = find(null, null, 'Onboarding_VoiceOS-CC')) PRICES.ccSetup = p;

        if(p = find('Standard Phones')) PRICES.hwBasic = p;
        if(p = find('Office Phones')) PRICES.hwOffice = p;
        if(p = find('Executive Phones')) PRICES.hwExec = p;
        if(p = find('Conference Phones')) PRICES.hwConf = p;
        
        if(p = find('Cordless Phones', 'Cordless Handset')) PRICES.hwCordlessHandset = p;
        if(p = find('Cordless Phones', 'Cordless Base')) PRICES.hwCordlessBase = p;

        if(p = find('Phone Misc', 'Wall Mount')) PRICES.hwWallMount = p;
        if(p = find('Phone Misc', 'Power Supply')) PRICES.hwPowerSupply = p;
        if(p = find('Phone Misc', 'Sidecar')) PRICES.sidecar = p;

        if(p = find(null, null, 'AMP_PS_STD_FC')) PRICES.deployHourly = p; // Custom prop
        if(p = find(null, null, 'AMP_PS_SVY_FC')) PRICES.pagingSurvey = p;

        // Update UI Display for Prices
        document.getElementById('price_stdUser').innerText = `$${PRICES.stdUser}/mo`;
        document.getElementById('price_advUser').innerText = `$${PRICES.advUser}/mo`;
        document.getElementById('price_ccAgent').innerText = `$${PRICES.ccAgent}/mo`;
        
        document.getElementById('price_hwBasic').innerText = `$${PRICES.hwBasic}`;
        document.getElementById('price_hwOffice').innerText = `$${PRICES.hwOffice}`;
        document.getElementById('price_hwExec').innerText = `$${PRICES.hwExec}`;
        document.getElementById('price_hwConf').innerText = `$${PRICES.hwConf}`;
    }

    // --- 3. UI INTERACTION (Restored from v7) ---
    
    // SIP Toggle Logic
    document.getElementById('sipTrunkingToggle').addEventListener('change', (e) => {
        const checked = e.target.checked;
        document.getElementById('sipDetails').classList.toggle('hidden', !checked);
        // Switch Animation
        const track = document.getElementById('sipTrack');
        const dot = document.getElementById('sipDot');
        if(checked) {
            track.classList.remove('bg-slate-200'); track.classList.add('bg-blue-500');
            dot.classList.add('translate-x-full');
        } else {
            track.classList.add('bg-slate-200'); track.classList.remove('bg-blue-500');
            dot.classList.remove('translate-x-full');
        }
        calculateTotals();
    });

    // PoE Logic (Restored v7 Force Logic)
    document.getElementById('customerPoE').addEventListener('change', updatePowerSupplies);

    function updatePowerSupplies() {
        const hasPoE = document.getElementById('customerPoE').checked;
        const psuInputs = document.querySelectorAll('.psu-unit');
        
        psuInputs.forEach(input => {
            const parentId = input.getAttribute('data-parent');
            const parentQty = val(parentId);
            
            if(!hasPoE) {
                // No PoE = Mandatory PSUs
                input.value = parentQty > 0 ? parentQty : '';
                input.setAttribute('readonly', true);
                input.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');
            } else {
                // Yes PoE = Optional
                input.removeAttribute('readonly');
                input.classList.remove('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');
                // We do NOT clear value here, user might still want them.
            }
        });
        calculateTotals();
    }

    // Parent/Child Validation (Restored)
    document.querySelectorAll('.acc-validate').forEach(input => {
        input.addEventListener('input', (e) => {
            const parentId = e.target.getAttribute('data-parent');
            const parentQty = val(parentId);
            if(val(e.target.id) > parentQty) e.target.value = parentQty;
            calculateTotals();
        });
    });

    // Main Listeners
    document.querySelectorAll('.calc-trigger').forEach(el => {
        el.addEventListener('input', calculateTotals);
        el.addEventListener('change', calculateTotals);
    });

    // Specific Parent Listener to update children limits
    document.querySelectorAll('.parent-hw').forEach(el => {
        el.addEventListener('input', () => {
            updatePowerSupplies(); // Re-eval mandatory counts
            // Also cap mounts
            const id = el.id;
            const qty = val(id);
            document.querySelectorAll(`[data-parent="${id}"]`).forEach(child => {
                if(val(child.id) > qty) child.value = qty;
            });
            calculateTotals();
        });
    });

    // --- 4. CALCULATOR LOGIC (v7 Ported) ---
    function calculateTotals() {
        let mrc = 0; let otc = 0;
        let mrcItems = []; let otcItems = [];

        // 1. Licenses
        const std = val('standardUsers');
        if(std) { mrc += std*PRICES.stdUser; otc += std*PRICES.stdSetup; mrcItems.push(row(`${std}x Std User`, std*PRICES.stdUser)); }
        
        const adv = val('advancedUsers');
        if(adv) { mrc += adv*PRICES.advUser; otc += adv*PRICES.advSetup; mrcItems.push(row(`${adv}x Adv User`, adv*PRICES.advUser)); }
        
        const cc = val('ccAgents');
        if(cc) { mrc += cc*PRICES.ccAgent; otc += cc*PRICES.ccSetup; mrcItems.push(row(`${cc}x CC Agent`, cc*PRICES.ccAgent)); }

        // 2. Numbers
        const totalSeats = std + adv + cc;
        const portL = val('portLocal'); const newL = val('newLocal');
        const portT = val('portTF');    const newT = val('newTF');
        const totalNums = portL + newL + portT + newT;
        
        const included = Math.min(totalNums, totalSeats);
        const excess = Math.max(0, totalNums - totalSeats);
        
        if(included > 0) mrcItems.push(`<div class="summary-row"><span class="summary-label text-green-600">${included}x DIDs (Included)</span><span class="summary-val">$0.00</span></div>`);
        if(excess > 0) { mrc += excess*1; mrcItems.push(row(`${excess}x Excess DIDs`, excess)); }
        
        if(newL > 0) { otc += newL*PRICES.newLocalSetup; otcItems.push(row(`${newL}x New DID Setup`, newL*PRICES.newLocalSetup)); }
        if(newT > 0) { otc += newT*PRICES.newTFSetup; otcItems.push(row(`${newT}x New TF Setup`, newT*PRICES.newTFSetup)); }
        
        // TF Bundle
        const tfMin = val('tfMinutes');
        if(tfMin > 0) {
            const bundles = Math.ceil(tfMin / 500);
            mrc += bundles * 15;
            mrcItems.push(row(`${bundles}x TF Min Bundle`, bundles*15));
            document.getElementById('tfCallout').classList.remove('hidden');
        } else {
            document.getElementById('tfCallout').classList.add('hidden');
        }

        // SIP Trunking
        if(document.getElementById('sipTrunkingToggle').checked) {
            const ch = val('sipChannels');
            mrc += ch * PRICES.sipChannel;
            otc += PRICES.sipSetup;
            mrcItems.push(row(`${ch}x SIP Channels`, ch*PRICES.sipChannel));
        }

        // 3. Hardware
        const basic = val('hwBasic'); if(basic) otc += basic*PRICES.hwBasic;
        const office = val('hwOffice'); if(office) otc += office*PRICES.hwOffice;
        const exec = val('hwExec'); if(exec) otc += exec*PRICES.hwExec;
        const conf = val('hwConf'); if(conf) otc += conf*PRICES.hwConf;
        
        // Cordless
        const cord = val('hwCordless');
        if(cord > 0) {
            const kits = Math.ceil(cord / 10);
            const extra = Math.max(0, cord - kits); // v7 logic: 8? User said 10. Using 10.
            const cost = (kits * PRICES.hwCordlessBase) + (extra * PRICES.hwCordlessHandset);
            otc += cost;
            otcItems.push(row(`${cord}x Cordless Total`, cost));
            document.getElementById('cordlessInfo').classList.remove('hidden');
        } else {
             document.getElementById('cordlessInfo').classList.add('hidden');
        }

        // Accessories
        const mounts = val('mount_basic')+val('mount_office')+val('mount_exec');
        if(mounts) otc += mounts*PRICES.hwWallMount;
        
        const psus = val('psu_basic')+val('psu_office')+val('psu_exec');
        if(psus) {
            otc += psus*PRICES.hwPowerSupply;
            otcItems.push(row(`${psus}x Power Supplies`, psus*PRICES.hwPowerSupply));
        }
        
        // Sidecars (Max Power Rule)
        const side = val('sidecars');
        if(side > 0) {
            let sCost = side * PRICES.sidecar;
            // v7 Logic: extraSidecarPSUs = ceil(sides/2). 
            // My previous logic: 1 per sidecar.
            // I will use v7 Logic as requested.
            let sidePSUs = Math.ceil(side / 2);
            sCost += (sidePSUs * PRICES.sidecarPSU);
            otc += sCost;
            otcItems.push(row(`${side}x Sidecars + PWR`, sCost));
            document.getElementById('sidecarPSUInfo').classList.remove('hidden');
        } else {
            document.getElementById('sidecarPSUInfo').classList.add('hidden');
        }

        // 4. Analog
        const efax = val('efaxQty');
        if(efax) { mrc += efax*PRICES.efax; otc += efax*PRICES.efaxSetup; mrcItems.push(row(`${efax}x E-Fax`, efax*PRICES.efax)); }
        
        const phyFax = val('physicalFaxQty');
        if(phyFax) {
            mrc += phyFax*PRICES.potsLine;
            otc += phyFax * (PRICES.ata + PRICES.phyFaxConfig); // HW + Setup
            mrcItems.push(row(`${phyFax}x Analog Line`, phyFax*PRICES.potsLine));
        }

        const paging = val('pagingQty');
        if(paging) {
            mrc += paging*PRICES.potsLine;
            otc += paging * (PRICES.ata + PRICES.pagingConfig);
            mrcItems.push(row(`${paging}x Paging Line`, paging*PRICES.potsLine));
        }

        // 5. Deployment
        const totalDev = basic + office + exec + conf + cord + phyFax + paging + side;
        document.getElementById('totalDeviceCount').innerText = totalDev + " Devices";
        
        // Install Fee
        const installCb = document.getElementById('includeInstall');
        const installStatus = document.getElementById('installStatus');
        const hasATA = (phyFax > 0 || paging > 0);
        
        // ATA Mandate Logic
        if(hasATA) {
            installCb.checked = true;
            installCb.disabled = true;
            installStatus.innerText = "MANDATORY (ATA)";
            installStatus.className = "text-[10px] font-bold text-orange-500";
        } else {
            installCb.disabled = (totalDev === 0);
            installStatus.innerText = "OPTIONAL";
            installStatus.className = "text-[10px] font-bold text-slate-500";
        }
        
        if(installCb.checked && totalDev > 0) {
            // v7 Logic: $169 per 5 devices.
            // My previous Inventory Logic: $200/hr.
            // User instruction: "On-Site Install is SKU AMP_PS_STD_FC". Price from Inventory is $200.
            // I will use Inventory Price ($200) and formula: ceil(total/5).
            const blocks = Math.ceil(totalDev / 5);
            const deployPrice = PRICES.deployHourly || 200; 
            const deployCost = blocks * deployPrice;
            otc += deployCost;
            otcItems.push(row(`Install (${blocks} blk)`, deployCost));
            document.getElementById('deployMsg').innerText = `$${deployPrice} / 5 dev`;
        } else {
            document.getElementById('deployMsg').innerText = "Add hardware...";
        }

        // Survey Logic
        const fpNo = document.getElementById('fpNo').checked;
        if(paging > 0 || fpNo) {
            otc += PRICES.pagingSurvey;
            otcItems.push(row(`Site Survey`, PRICES.pagingSurvey));
        }

        // Render Totals
        document.getElementById('totalMRC').innerText = `$${mrc.toFixed(2)}`;
        document.getElementById('totalOTC').innerText = `$${otc.toFixed(2)}`;
        document.getElementById('mrcList').innerHTML = mrcItems.length ? mrcItems.join('') : '<div class="text-sm text-slate-600 italic">No items...</div>';
        document.getElementById('otcList').innerHTML = otcItems.length ? otcItems.join('') : '<div class="text-sm text-slate-600 italic">No items...</div>';
    }

    function row(name, price) {
        return `<div class="summary-row"><span class="summary-label">${name}</span><span class="summary-val">$${price.toFixed(2)}</span></div>`;
    }
    
    // --- 5. SAVE TO LEAD NOTES ---
    function handleSaveToNotes() {
        const btn = document.getElementById('btnSave');
        const originalText = btn.innerHTML;
        btn.innerText = "Saving...";
        btn.disabled = true;

        const summary = generateSummaryText();
        
        ZOHO.CRM.API.addRecord({
            Entity: "Notes",
            APIData: {
                "Parent_Id": LEAD_ID,
                "Se_Module": "Leads",
                "Note_Title": "VoiceOS Config Worksheet",
                "Note_Content": summary
            }
        }).then(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            const fb = document.getElementById('saveFeedback');
            fb.classList.remove('opacity-0');
            setTimeout(() => fb.classList.add('opacity-0'), 3000);
        }).catch(e => {
            console.error(e);
            alert("Error saving note: " + JSON.stringify(e));
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }

    function generateSummaryText() {
        // Simple text builder for the Note
        let t = `LEAD CONFIG - ${new Date().toLocaleDateString()}\n=========================\n`;
        t += `[1] SEATS\n`;
        if(val('standardUsers')) t += `- Std: ${val('standardUsers')} @ $${PRICES.stdUser}\n`;
        if(val('advancedUsers')) t += `- Adv: ${val('advancedUsers')} @ $${PRICES.advUser}\n`;
        if(val('ccAgents')) t += `- CC: ${val('ccAgents')} @ $${PRICES.ccAgent}\n`;
        
        t += `\n[2] HARDWARE\n`;
        if(val('hwBasic')) t += `- Basic: ${val('hwBasic')}\n`;
        if(val('hwOffice')) t += `- Office: ${val('hwOffice')}\n`;
        if(val('hwExec')) t += `- Exec: ${val('hwExec')}\n`;
        
        const psus = val('psu_basic')+val('psu_office')+val('psu_exec');
        if(psus > 0) t += `- PSUs: ${psus} (PoE: ${document.getElementById('customerPoE').checked ? 'YES' : 'NO'})\n`;
        
        t += `\n[3] TOTALS\n`;
        t += `MRC: ${document.getElementById('totalMRC').innerText}\n`;
        t += `OTC: ${document.getElementById('totalOTC').innerText}\n`;
        return t;
    }

    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        let element = document.getElementById('quoteContainer');
        let canvas = await html2canvas(element, { scale: 1.5 });
        let imgData = canvas.toDataURL('image/jpeg', 0.95);
        let pdf = new jsPDF('p', 'mm', 'a4');
        let pdfWidth = pdf.internal.pageSize.getWidth();
        let pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`Quote_${LEAD_NAME.replace(/\W/g,'_')}.pdf`);
    }

    // Helper
    function val(id) { return parseFloat(document.getElementById(id).value) || 0; }
    function showLoader(s) { document.getElementById('loader').style.display = s ? 'block' : 'none'; }

</script>
</body>
</html>
